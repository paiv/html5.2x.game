Math.trunc=Math.trunc||function(c){return 0>c?Math.ceil(c):Math.floor(c)};
var ua=function(){function c(){this.context=new (window.AudioContext||window.webkitAudioContext);this.j={};for(var m=0,q=K.length;m<q;m++)this.load(K[m],this.decode.bind(this))}var K=["sfx/pickup_coin.wav","sfx/drill.wav","sfx/win.wav","sfx/loose.wav"];c.prototype.load=function(m,q){var c=new XMLHttpRequest;c.onload=function(){300>this.status?q(m,this.response):console.error(this.status,this.statusText,m)};c.open("GET",m);c.responseType="arraybuffer";c.send()};c.prototype.decode=function(m,c){this.context.decodeAudioData(c,
this.cache.bind(this,m))};c.prototype.cache=function(m,c){this.j[m]=c};c.prototype.G=function(c){if(c){var q=this.context.createBufferSource();q.buffer=c;q.connect(this.context.destination);q.start()}};c.prototype.ga=function(){this.G(this.j["pickup_coin.wav"])};c.prototype.ja=function(){this.G(this.j["win.wav"])};c.prototype.fa=function(){this.G(this.j["loose.wav"])};c.prototype.T=function(c){var q=this.j["drill.wav"];if(q&&!this.D){var y=this.context.createBufferSource(),z=this.context.createGain();
z.gain.value=c;y.buffer=q;y.loop=!0;y.connect(z);z.connect(this.context.destination);this.D=z;y.start()}this.D&&(this.D.gain.value=c)};return c}(),Fa=function(){function c(){}function K(){var a=new Image;a.onload=function(){u.L=new va(a,100,100,20)};a.src="img/monster.png"}var m,q,y,z,F,O,P,Q,R,S,T,U,V,W,X,Y;function fa(a){var b="keydown"===a.type;switch(a.keyCode){case 13:O=b;break;case 27:P=b;break;case 32:Q=b;break;case 37:R=b;break;case 38:S=b;break;case 39:T=b;break;case 40:U=b;break;case 65:V=
b;break;case 87:W=b;break;case 68:X=b;break;case 83:Y=b}}function wa(a){a.target.getBoundingClientRect()}function ga(){}function ha(){var a=!0;if(navigator.getGamepads){for(var b=navigator.getGamepads(),f,d=0,k=b.length;d<k;d++)if(b[d]&&b[d].c){f=b[d];break}b=f;f={};if(b&&b.c){f.c=!0;for(var d=[],k=0,g=b.buttons.length;k<g;k++){var n=b.buttons[k].value;9E-4>n&&(n=0);d.push(n)}f.buttons=d;d=[];k=0;for(g=b.f.length;k<g;k++)if(1==k%2){var n=b.f.slice(k-1,k+1),w=n[0],e=n[1],w=Math.sqrt(w*w+e*e);1.2<w&&
(w=1.2);w=.25>w?0:(w-.25)/.95;d.push({ya:180*Math.atan2(-n[1],n[0])/Math.PI,value:w,f:n})}f.o=d}else f.c=!1,f.buttons=[],f.o=[];t=f}else a=!1;ia!==t.c&&(b=document.querySelector("#gamepadIcon"),t.c?(b.classList.remove("disabled"),b.setAttribute("title","Gamepad connected")):(b.classList.add("disabled"),b.setAttribute("title",a?"To activate Gamepad, press any button":"No Gamepad support in "+navigator.userAgent)),ia=t.c)}function ja(a){console.log((new Date).getTime(),a.type,a)}function G(a,b){return{x:1*
(a+.5),y:1*(b+.5)}}function ka(a,b){return{a:Math.floor(b.x/(v/r/a.width)),b:Math.floor(b.y/(C/r/a.height))}}function Z(a,b){return{a:b%a.width,b:Math.floor(b/a.width)}}function xa(a,b){function f(d,f){for(var n=0,w=0;n<a.height;n++)for(var e=0;e<a.width;e++,w++){var l=d.charAt(w);if(0<=f.indexOf(l))switch(l){case "#":var l=b,c=G(e,n),h=.42/5,m=c.x*r,q=c.y*r,x=.42*r;l.save();l.translate(m,q);l.strokeStyle="rgb(136,20,0)";l.fillStyle="rgb(252,160,68)";h*=r;l.lineWidth=h;l.fillRect(-x,-x,2*x,2*x);l.strokeRect(-x,
-x,2*x,2*x);m=2*(x-h)/5;l.lineWidth=m/3;l.lineCap="round";for(q=0;5>q;q++){var t=-x+h+(q+.5)*m,u=q*m;l.beginPath();l.moveTo(-x+h+u,t);l.lineTo(x-h-u,t);l.stroke()}l.restore();L.units.push({type:"rect",x:c.x-.42,y:c.y-.42,width:.84,height:.84});break;case '"':l=b;c=G(e,n);h=c.x*r;m=c.y*r;x=.5*r;l.save();l.translate(h,m);l.lineWidth=1;h=90+Math.round(15*Math.random());m=Math.round((170+15*Math.random()-h)/10);for(q=0;10>q;q++,h+=m){l.fillStyle="rgb(0,"+h+",0)";var t=(-.2+.4*Math.random())*x,u=(-.2+
.4*Math.random())*x,v=(.2+(10-q)/10*(.5+.3*Math.random()))*x;l.save();l.scale(.9+.1*Math.random(),.9+.1*Math.random());l.beginPath();l.arc(t,u,v,0,2*Math.PI);l.fill();l.restore()}l.restore();L.units.push({type:"circle",x:c.x,y:c.y,r:.5-.48*p.width})}}}var d=a.data.replace(/\s/g,"");f(d,"#");f(d,'"')}function ya(a){function b(b,f){var g=b.indexOf(f);if(0<=g)return g=Z(a,g),G(g.a,g.b);for(;;){var g=Math.floor(a.width*Math.random()),n=Math.floor(a.height*Math.random());if("."===b.charAt(n*a.width+g))return G(g,
n)}}var f=a.data.replace(/\s/g,"");return{N:b(f,"@"),U:b(f,"$"),O:b(f,"&")}}function la(a){function b(a){return{a:Math.floor(a.x/k),b:Math.floor(a.y/g)}}function f(a,b,f,k){for(var g=a.a-b,e=a.a+b+1;g<e;g++)for(var c=a.b-b,h=a.b+b+1;c<h;c++){var p=g,m=c,q=k;if(0<=p&&0<=m&&p<B.width&&m<B.height){var r=m*B.width+p;B.C[r]||(f&&(B.C[r]=!0),d.push({a:p,b:m,alpha:q}))}}}var d=[],k=v/r/B.width,g=C/r/B.height;f(b(a),B.S,!0,0);f(b(a),B.S+1,!1,.75);0<d.length&&za(M,d)}function za(a,b){function f(b){var d=k*
b.a;b=g*b.b;a.save();a.translate(d,b);a.clearRect(0,0,k,g);a.restore()}function d(b,d){if(0>=d)f(b);else{for(var n=Math.round(255*d),e=k*b.a,c=g*b.b,h=a.getImageData(e,c,k,g),w=0,p=h.data.length;w<p;w++)3==w%4&&(h.data[w]=n);f(b);a.putImageData(h,e,c)}}for(var k=v/B.width,g=C/B.height,n=0,e=b.length;n<e;n++){var c=b[n];d(c,c.alpha)}}function ma(a){var b,f,d=a-H;H=a;ha();a:{z=y=q=m=!1;F=P||O||Q;t.c&&(F=F||t.buttons[aa.V]||t.buttons[aa.W]||t.buttons[aa.X]);if(t.c&&(m=0<t.buttons[14],q=0<t.buttons[12],
y=0<t.buttons[15],z=0<t.buttons[13],m||q||y||z))break a;if(t.c&&(m=-.5>t.o[0].f[0],q=-.5>t.o[0].f[1],y=.5<t.o[0].f[0],z=.5<t.o[0].f[1],m||q||y||z))break a;m=R||V;q=S||W;y=T||X;z=U||Y}switch(h.state){case I.I:a=p;a.speed.x=m?-3:y?3:0;a.speed.y=q?-3:z?3:0;if(a.speed.x||a.speed.y)a.facing=Math.atan2(a.speed.y,a.speed.x);(m||y)&&(q||z)&&(a.speed.x*=Math.SQRT1_2,a.speed.y*=Math.SQRT1_2);na(a,d)&&la(a);a=u;var k=p.l?3.2:1,g=!1;2E3<H-a.ha&&(a.w=void 0);var n=a.w;if(!n){b=ka(h.map,a);f=ka(h.map,p);if(b.a==
f.a&&b.b==f.b)n=[b];else{var n="("+b.a+","+b.b+")-"+("("+f.a+","+f.b+")"),c=h.R[n];if(!c){var D=new Aa(h.v,f,{id:b.b*h.map.width+b.a,path:[b],m:b,i:0,s:oa(b,f)});b:{var c={},l=new Ba(D.ca);for(l.push(D);0<l.length;){D=l.pop();if(D.ea()){c=D;break b}c[D.id]||(c[D.id]=!0,l.addAll(D.ba()))}c=void 0}c=c?c.path:[b,f];b=0;for(f=c.length;b+1<f;b++)h.R[n]=c}n=c}a.ha=H}if(n)for(a.w=n;!g&&0<n.length;)if(b=n[0],f=G(b.a,b.b),b=f.x-a.x,f=f.y-a.y,c=Math.sqrt(b*b+f*f),.1>c)a.w=n=n.slice(1);else{k=d/1E3*k<c+.1?k:
c;a.speed.x=k*b/c;a.speed.y=k*f/c;g=na(a,d);break}g||(a.w=void 0,a.A=a.x,a.J=a.y);ba(p.g(),u.g())&&(p.h=!0);!p.l&&ba(p.g(),A.g())&&(p.l=!0,A.A=A.x,A.J=A.y,A.x=p.x,A.y=p.y,A.P=!0,J.ga());p.l&&(A.x=p.x,A.y=p.y,A.facing=p.facing);ca(e,p);ca(e,u);d=p;a=d.x*r;k=d.y*r;g=d.width*r/2;e.save();e.translate(a,k);e.rotate(d.facing);e.fillStyle=d.h?"rgb(168,168,168)":"rgb(168,16,0)";e.beginPath();e.arc(0,-.7*g,g/2,0,2*Math.PI);e.fill();e.beginPath();e.arc(0,.7*g,g/2,0,2*Math.PI);e.fill();e.fillStyle=d.h?"rgb(228,228,228)":
"rgb(228,0,88)";e.beginPath();e.arc(0,0,g,0,2*Math.PI);e.fill();e.strokeStyle=d.h?"#aaa":"#fff";e.lineWidth=.25*g;e.beginPath();e.arc(0,0,.8*g,.309*-Math.PI,.309*Math.PI);e.stroke();e.restore();d=A;a=d.x*r;k=d.y*r;g=d.width*r/2;d.P&&(d.P=!1,ca(e,d));e.save();e.translate(a,k);d.facing&&e.rotate(d.facing);e.strokeStyle="rgb(136,20,0)";e.fillStyle="rgb(248,216,120)";e.lineWidth=1;e.beginPath();e.arc(0,0,g,0,2*Math.PI);e.fill();e.stroke();e.fillStyle="rgb(136,20,0)";e.textAlign="center";e.textBaseline=
"middle";e.fillText("\u273f",0,0);e.restore();u.L&&u.L.ia(e,H,Math.round((u.x-u.width/2)*r),Math.round((u.y-u.width/2)*r),u.width*r/u.L.aa);!p.h&&p.x>=E.x&&p.x<E.x+E.width&&p.y>=E.y&&p.y<E.y+E.height?(d=u.x-p.x,a=u.y-p.y,d=(v-r*Math.sqrt(d*d+a*a))/v,J.T(Math.min(1,d*d))):(h.state=I.M,h.H=(Date.now()-h.startTime)/1E3,d=h.H,a=0,p.h?a=-100+Math.max(0,100-(d||0)):p.l&&(a=100+Math.max(0,110-(d||0))),h.B=Math.trunc(a),0<h.B?J.ja():J.fa());break;case I.M:F?(h.state=I.I,da.clearRect(0,0,v,C),e.clearRect(0,
0,v,C),ea.clearRect(0,0,v,C),M.clearRect(0,0,v,C),N.clearRect(0,0,v,C),pa&&pa.clearRect(0,0,v,C),qa()):(d=N,a=h.B,d.save(),d.translate(0,Math.round((C-100)/2)),d.fillStyle="rgba(204, 204, 204, .1)",d.fillRect(0,0,v,100),d.textAlign="center",d.textBaseline="middle",d.translate(Math.round(v/2),Math.round(50)),d.fillStyle="black",d.fillText("YOUR SCORE: "+a,0,0),d.restore()),J.T(0)}requestAnimationFrame(ma)}function Ca(a){var b=getComputedStyle(a),f=b.getPropertyValue("width"),b=b.getPropertyValue("height");
a=a.querySelectorAll("canvas");for(var d=0,k=a.length;d<k;d++){var g=a[d];g.setAttribute("width",f);g.setAttribute("height",b)}}function Da(a){function b(b){var d=document.createElement("canvas");d.id=b;a.appendChild(d);return d}var f=b("earthCanvas"),d=b("gameCanvas"),k=b("mapCanvas"),g=b("fogCanvas"),c=b("menuCanvas");Ca(a);da=f.getContext("2d");e=d.getContext("2d");ea=k.getContext("2d");M=g.getContext("2d");N=c.getContext("2d");v=e.canvas.width;C=e.canvas.height;r=v/ra.width;e.font='0.8em "Lucida Console", Monaco, monospace';
N.font="2em Verdana, Geneva, sans-serif"}function qa(){h.map=ra;for(var a=h.map,b={},f=a.data.replace(/\s/g,""),d=0,k=0;d<a.height;d++)for(var g=0;g<a.width;g++,k++)switch(f.charAt(k)){case "#":case '"':break;default:b[k]=[]}f=Object.keys(b);d=0;for(k=f.length;d<k;d++){var g=b[f[d]],c;c=Z(a,f[d]);c=[{a:c.a-1,b:c.b},{a:c.a+1,b:c.b},{a:c.a,b:c.b-1},{a:c.a,b:c.b+1}];for(var e=0,m=c.length;e<m;e++){var l=c[e],l=l.b*a.width+l.a;b[l]&&g.push(l)}}h.v=b;h.R={};h.B=0;h.startTime=Date.now();h.H=0;a=da;b=a.canvas.width;
f=a.canvas.height;a.lineWidth=1;d=550+50*Math.random();for(k=0;k<d;k++){g=b*Math.random();c=f*Math.random();a.save();a.translate(g,c);a.beginPath();for(g=1;4>g;g++)a.strokeStyle="hsl(45, 100%,"+(43+Math.round(30*Math.random()))+"%)",a.lineTo(g,-4*Math.random());a.stroke();a.restore()}xa(h.map,ea);E.width=h.map.width;E.height=h.map.height;a=ya(h.map);p.x=a.N.x;p.y=a.N.y;p.facing=-Math.PI/2;p.h=!1;p.l=!1;A.x=a.U.x;A.y=a.U.y;u.x=a.O.x;u.y=a.O.y;B.C=[];a=M;b=B;f=v/b.width;d=C/b.height;a.fillStyle="rgb(238,238,238)";
a.lineWidth=1;for(k=0;k<b.height;k++)for(g=0;g<b.width;g++)if(!b.C[k*b.width+g]){c=f*g;e=d*k;a.save();a.translate(c,e);a.fillRect(0,0,f,d);c=2*Math.random();for(e=0;e<c;e++)m=f*Math.random(),l=d*Math.random(),a.save(),a.strokeStyle="hsl(180, 80%,"+Math.round(60+20*Math.random())+"%)",a.beginPath(),a.arc(m,l,4+10*Math.random(),2*Math.PI*Math.random(),2*Math.PI*Math.random()),a.stroke(),a.restore();a.restore()}la(p)}function sa(a,b){var f=a.x,d=a.y;f<b.x&&(f=b.x);f>b.x+b.width&&(f=b.x+b.width);d<b.y&&
(d=b.y);d>b.y+b.height&&(d=b.y+b.height);return(a.x-f)*(a.x-f)+(a.y-d)*(a.y-d)<=a.r*a.r}function ba(a,b){var f;if("circle"===a.type&&"circle"==b.type){f=b.x-a.x;var d=b.y-a.y,c=a.r+b.r;f=f*f+d*d<=c*c}else f="circle"===a.type&&"rect"==b.type?sa(a,b):"rect"===a.type&&"circle"==b.type?sa(b,a):"rect"===a.type&&"rect"==b.type?a.x>b.x+b.width||a.x+a.width<b.x||a.y>b.y+b.height||a.y+a.height<b.y?!1:!0:!1;return f}function na(a,b){if(0==a.speed.x&&0==a.speed.y)return!1;var f=a.x+b/1E3*a.speed.x,d=a.y+b/1E3*
a.speed.y,c;a:{c={type:"circle",x:f,y:d,r:a.width/2};for(var g=0,e=L.units.length;g<e;g++)if(ba(c,L.units[g])){c=!1;break a}c=!0}return c?(a.A=a.x,a.J=a.y,a.x=f,a.y=d,!0):!1}function oa(a,b){return Math.abs(b.a-a.a)+Math.abs(b.b-a.b)}function ca(a,b){if(void 0!==b.A){var f=b.A*r,d=b.J*r,c=b.K;a.save();a.translate(f,d);a.clearRect(c.x*r,c.y*r,c.width*r,c.height*r);a.restore()}}var H=0,ta,e,v,C,r,ea,da,M,N,pa;Y=X=W=V=U=T=S=R=Q=P=O=void 0;var t={},aa={V:0,ka:1,wa:2,xa:3,qa:4,ta:5,sa:6,va:7,W:8,X:9,ra:10,
ua:11,oa:12,la:13,ma:14,na:15,pa:16},ia;F=z=y=q=m=void 0;var J=new ua,p={width:.5,x:-1,y:-1,facing:-Math.PI/2,speed:{x:0,y:0},K:{x:-.35,y:-.35,width:.7,height:.7},g:function(){return{type:"circle",x:this.x,y:this.y,r:this.width/2}}},B={width:20,height:20,S:2,C:[]},L={units:[]},u={width:1.1,x:2.5,y:2.5,speed:{x:0,y:0},K:{x:-.6,y:-.6,width:1.2,height:1.2},g:function(){return{type:"circle",x:this.x,y:this.y,r:this.width/2}}},A={width:.4,x:-1,y:-1,K:{x:-.35,y:-.35,width:.7,height:.7},g:function(){return{type:"circle",
x:this.x,y:this.y,r:this.width/2}}},E={x:0,y:0,width:-1,height:-1},I={I:1,M:2},h={state:I.I,startTime:0,H:0,B:0},ra={width:10,height:10,data:'" " " " " " " " " "" . . . . . . . . "" . . " " " . " " "" . . . . . . . " "" " . " # # # " " "" . . . . . . " " "" " . " . " " " . "" . . . . . . . . "" " " " . " " . @ "" " " " " " " " < "'},Ba=function(){function a(a){this.items=[];this.Y=function(c,d){return a.call(d)-a.call(c)}}Object.defineProperty(a.prototype,"length",{get:function(){return this.items.length}});
a.prototype.push=function(a){this.items.push(a);this.items.sort(this.Y)};a.prototype.pop=function(){return this.items.pop()};a.prototype.addAll=function(a){for(var c=0,d=a.length;c<d;c++)this.push(a[c])};return a}(),Aa=function(){function a(a,c,d){this.v=a;this.u=c;this.id=d.id;this.path=d.path;this.m=d.m;this.i=d.i;this.s=d.s}a.prototype.ea=function(){return this.m.a==this.u.a&&this.m.b==this.u.b};a.prototype.ca=function(){return this.i+this.s};a.prototype.ba=function(){for(var a=[],c=this.v[this.id],
d=0,e=c.length;d<e;d++){var g=c[d],n=Z(h.map,g),g=new this.constructor(this.v,this.u,{id:g,path:this.path.concat([n]),m:n,i:this.i+1,s:oa(n,this.u)});a.push(g)}return a};return a}(),Ea=function(){function a(a,c,d,e,g){this.da=a;this.x=c;this.y=d;this.width=e;this.height=g}a.prototype.Z=function(a,c,d,e){a.drawImage(this.da,this.x,this.y,this.width,this.height,c,d,this.width*e,this.height*e)};return a}(),va=function(){function a(a,c,d,e){this.sheet=a;this.aa=c;this.$=e;e=[];for(var g=0;g<a.height;g+=
d)for(var h=0;h<a.width;h+=c)e.push(new Ea(a,h,g,c,d));this.frames=e;this.index=0;this.F=void 0}a.prototype.ia=function(a,c,d,e,g){if(void 0===this.F||(c-this.F)/1E3>=1/this.$)this.index=(this.index+1)%this.frames.length,this.F=c;this.frames[this.index].Z(a,d,e,g)};return a}();c.prototype.start=function(){K();ta=document.createElement("div");document.body.appendChild(ta);var a=document.querySelector("#gameContainer");Da(a);window.addEventListener("keydown",fa);window.addEventListener("keyup",fa);
a.addEventListener("mousemove",wa);a.addEventListener("mousedown",ga);a.addEventListener("mouseup",ga);ha();window.addEventListener("gamepadconnected",ja);window.addEventListener("gamepaddisconnected",ja);qa();requestAnimationFrame(ma)};return c}();window.onload=function(){var c=document.querySelector("#gamepadIcon");c.onclick=function(){alert(c.title)};(new Fa).start()};
